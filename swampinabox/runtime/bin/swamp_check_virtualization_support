#!/bin/bash

# This file is subject to the terms and conditions defined in
# 'LICENSE.txt', which is part of this source code distribution.
#
# Copyright 2012-2018 Software Assurance Marketplace

#
# Check that 'kvm' virtualization is supported.
#

encountered_error=0
trap 'encountered_error=1; echo "Error: $0: $BASH_COMMAND" 1>&2' ERR
set -o errtrace

##########################################################################

if which dmidecode 1>/dev/null 2>/dev/null ; then
    if [ "$(whoami)" = "root" ]; then
        echo "Looking for system manufacturer ... $(dmidecode -s system-manufacturer)"
        echo "Looking for system product name ... $(dmidecode -s system-product-name)"
    fi
fi

##########################################################################

if grep -E '(vmx|svm)' /proc/cpuinfo 1>/dev/null 2>/dev/null ; then
    echo "Looking for Intel Virtual Technology CPU extensions ... found"
else
    echo "Error: Looking for Intel Virtual Technology CPU extensions ... not found"
    echo "Try enabling Intel Virtual Technology extensions in the BIOS."
    exit 1
fi

if lsmod | grep kvm 1>/dev/null 2>/dev/null ; then
    echo "Looking for 'kvm' kernel modules ... loaded"
else
    echo "Error: Looking for 'kvm' kernel modules ... not loaded"
    echo "Try loading the 'kvm' kernel module."
    exit 1
fi

exit $encountered_error
