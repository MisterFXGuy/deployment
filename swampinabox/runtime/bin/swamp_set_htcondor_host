#!/bin/bash

# This file is subject to the terms and conditions defined in
# 'LICENSE.txt', which is part of this source code distribution.
#
# Copyright 2012-2017 Software Assurance Marketplace

#
# Set the hostname of the HTCondor installation in all relevant
# configuration locations.  There's an implicit assumption here that the
# entire installation is running on one host.
#

NEW_HOSTNAME="$1"

if [ -z "$NEW_HOSTNAME" ]; then
    echo "Usage: $0 <new hostname>"
    exit 1
fi

IP_ADDRESS=$(perl -e 'use Socket; print inet_ntoa(inet_aton($ARGV[0]))' "$NEW_HOSTNAME" 2>/dev/null)

if [ $? -ne 0 ]; then
    echo "Error: Unable to determine an IP address for $NEW_HOSTNAME."
    exit 1
fi

if [ "$(whoami)" != "root" ]; then
    echo "Error: This utility must be run as root. Perhaps use 'sudo'."
    exit 1
fi

echo "Beginning to configure $NEW_HOSTNAME as the HTCondor host"

#
# Simple function for abstracting out the invocation of 'sed'.
#
function update_config() {
    key="$1"
    val="$2"
    target="$3"
    nospace="$4"

    val=${val//\//\\\/}

    if [ -r "$target" ]; then
        echo "Updating $target ($key)"
        if [ "$nospace" = "-nospace" ]; then
            sed -i "s/^\s*$key\s*=.*$/$key=$val/" "$target"
        else
            sed -i "s/^\s*$key\s*=.*$/$key = $val/" "$target"
        fi
    fi
}

#
# Update swamp.conf (backend)
#
target="/opt/swamp/etc/swamp.conf"

for key in htcondor_collector_host; do
    update_config "$key" "$NEW_HOSTNAME" "$target"
done

#
# Update .env (web server)
#
target="/var/www/swamp-web-server/.env"

for key in HTCONDOR_COLLECTOR_HOST; do
    update_config "$key" "$NEW_HOSTNAME" "$target" -nospace
done

#
# Update /etc/condor/config.d (HTCondor itself)
#
update_config "NETWORK_INTERFACE" "$IP_ADDRESS"   "/etc/condor/config.d/swampinabox_10_network.conf"
update_config "NETWORK_HOSTNAME"  "$NEW_HOSTNAME" "/etc/condor/config.d/swampinabox_10_network.conf"
update_config "CONDOR_HOST"       "$NEW_HOSTNAME" "/etc/condor/config.d/swampinabox_20_main.conf"
update_config "UID_DOMAIN"        "$NEW_HOSTNAME" "/etc/condor/config.d/swampinabox_30_jobcontrol.conf"
update_config "ALLOW_WRITE"       "$NEW_HOSTNAME" "/etc/condor/config.d/swampinabox_30_jobcontrol.conf"

htcondor_service_status=$(/opt/swamp/sbin/swamp_manage_service condor status)

if [ "$htcondor_service_status" = "running" ]; then
    echo "Restarting HTCondor"
    /opt/swamp/sbin/swamp_manage_service condor restart
fi

echo "Finished configuring $NEW_HOSTNAME as the HTCondor host"
