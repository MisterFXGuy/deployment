#!/bin/bash

# This file is subject to the terms and conditions defined in
# 'LICENSE.txt', which is part of this source code distribution.
#
# Copyright 2012-2017 Software Assurance Marketplace

#
# Set the hostname of the web server in all relevant configuration locations.
#

encountered_error=0
trap 'encountered_error=1; echo "Error: $0: $BASH_COMMAND" 1>&2' ERR
set -o errtrace

############################################################################

NEW_HOSTNAME="$1"

if [ -z "$NEW_HOSTNAME" ]; then
    echo "Usage: $0 <new hostname>" 1>&2
    exit 1
fi

if ! perl -e 'use Socket; print inet_ntoa(inet_aton($ARGV[0]))' "$NEW_HOSTNAME" 1>/dev/null 2>/dev/null ; then
    echo "Error: Unable to determine an IP address for: $NEW_HOSTNAME" 1>&2
    exit 1
fi

if [ "$(whoami)" != "root" ]; then
    echo "Error: This utility must be run as 'root'. Perhaps use 'sudo'." 1>&2
    exit 1
fi

#
# Simple function for abstracting out the invocation of 'sed'.
#
function update_config() {
    key="$1"
    val="$2"
    target="$3"
    nospace="$4"

    val=${val//\//\\\/}

    if [ -r "$target" ]; then
        echo "Updating: $target: $key"
        if [ "$nospace" = "-nospace" ]; then
            sed -i "s/^\s*$key\s*=.*$/$key=$val/" "$target"
        else
            sed -i "s/^\s*$key\s*=.*$/$key = $val/" "$target"
        fi
    fi
}

#
# Update swamp.conf (backend)
#
target="/opt/swamp/etc/swamp.conf"

update_config "reporturl" "https://$NEW_HOSTNAME/results/" "$target"

#
# Update .env (web server)
#
target="/var/www/swamp-web-server/.env"

for key in APP_URL APP_CORS_URL; do
    update_config "$key" "https://$NEW_HOSTNAME" "$target" -nospace
done

#
# Update config.json (web server)
#
target="/var/www/html/config/config.json"

if [ -f "$target" ]; then
    echo "Updating: $target"
    /opt/swamp/sbin/swamp_set_config_json_host "$NEW_HOSTNAME"
fi

#
# Update database
#
TMP_FILE=$(mktemp /tmp/swamp_set_web_host.XXXXXX.sql)

trap 'rm -f $TMP_FILE; exit 1' INT TERM

cat >"$TMP_FILE" <<END_DB_SCRIPT
    DELETE FROM assessment.system_setting WHERE system_setting_code='OUTGOING_BASE_URL';
    DELETE FROM assessment.system_setting WHERE system_setting_code='CODEDX_BASE_URL';
    INSERT INTO assessment.system_setting (system_setting_code, system_setting_value) VALUES ('OUTGOING_BASE_URL', 'https://$NEW_HOSTNAME/results/');
    INSERT INTO assessment.system_setting (system_setting_code, system_setting_value) VALUES ('CODEDX_BASE_URL', 'https://$NEW_HOSTNAME/');
END_DB_SCRIPT

echo "Updating database records"
/opt/swamp/sbin/execute_sql_script "$TMP_FILE"
rm -f "$TMP_FILE"

exit $encountered_error
