[[troubleshooting]]
[appendix]
Troubleshooting SWAMP-in-a-Box
------------------------------


[[troubleshooting-installing-dependencies]]
Resolving Issues with Installing SWAMP-in-a-Box's Dependencies
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The SWAMP-in-a-Box setup and install process requires downloading and
installing packages from multiple package repositories. On systems
configured to check for GPG signatures on the repositories' metadata, this
process might fail because not all of the repositories provide GPG
signatures for their metadata. This is indicated by HTTP 404 errors when
attempting to download `repomd.xml.asc` from the repository:

----
http://example.com/.../repomd.xml.asc: [Errno 14] HTTP Error 404 - Not Found
----

These GPG signature checks can be disabled by changing `repo_gpgcheck=1` to
`repo_gpgcheck=0` in the configuration files used by `yum` (you will need
`root` access to modify these files). To locate the configuration files that
currently contain `repo_gpgcheck=1`, run the following command:

----
grep -lr "repo_gpgcheck=1" /etc/yum.conf /etc/yum.repos.d/
----


[[troubleshooting-collect-logs]]
Collecting Log Files for Sending to SWAMP Staff
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When helping debug an issue with assessments not running, SWAMP staff might
ask to see the SWAMP's and HTCondor's log files. Run the following command
to bundle these log files, along with HTCondor's configuration files, into
a single file:

----
tar -zcv -f swampinabox-logs.tar.gz --exclude="*.old" \
    /opt/swamp/log/*.errors \
    /opt/swamp/log/*.log \
    /var/log/condor/*Log \
    /var/log/condor/*Log.slot* \
    /etc/condor
----

This will create a file `swampinabox-logs.tar.gz` in the current working
directory, which can then be <<support-and-contact-info,sent to SWAMP
staff>>. Errors from `tar` such as `No such file or directory` may safely be
ignored (some of the log files that the command looks for might not exist on
all systems).


Investigating Why an Assessment Failed
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The status of an assessment can be monitored from the Assessment Results
page of the SWAMP web application. If "Auto Refresh" is checked, the page
will refresh itself periodically.

If an assessment reaches a status of "Finished with Errors", the SWAMP is
generally functioning as expected, but the assessment failed to yield any
results. Click the "Error" button to view a detailed report about the
failure. The report includes a link to
https://www.swampinabox.org/doc/statusout.pdf[Status.out and Debugging SWAMP
Failures], which describes the contents of the assessment's "status.out"
file.

If an assessment appears to reach some other error state, the assessment's
log file might indicate why:

1. On the Assessment Results page, click on the status string to go the
Assessment Run Status page. Locate the execution record UUID.

2. The assessment's log file will be located at
`/opt/swamp/log/<execution-record-UUID>.log` on the SWAMP-in-a-Box host.


Investigating Why an Assessment Is "Waiting in HTCondor Queue"
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

SWAMP-in-a-Box uses virtual machines managed by an HTCondor pool to perform
assessments of packages. If assessments remain at a status of "Waiting in
HTCondor Queue" and never appear to make progress, the HTCondor pool may
have an issue that is preventing it from running the assessments.


==== Determining Whether HTCondor Is Generally Functional ====

HTCondor maintains a queue of jobs and a collection of resources to run
those jobs. For SWAMP-in-a-Box, each job corresponds to a single assessment
or instance of the <<add-on-viewers,Code Dx viewer>>. The `condor_q` and
`condor_status` commands can be used to examine these aspects of HTCondor:

* `condor_q`: Lists the jobs currently in the queue. HTCondor's ID for each
  job is shown in the "ID" column. The status of each job is shown in the
  "ST" column: "I" for idle; "R" for running; and "H" for on-hold,
  indicating that the job encountered an error.

+
`condor_q -better-analyze <job ID>` displays detailed information about why
an idle job is not currently running. On a normally functioning system, it
is common for a job to be idle because there are not enough free CPU or
memory resources available yet (wait for other assessments to finish
running).

+
`condor_q -hold <job ID>` displays information about why a job is on-hold.
On a normally functioning system, no job should be on-hold.

* `condor_status`: Lists all of the available resources that HTCondor can
  use to run jobs. On a normally functioning system, there should be at
  least one "machine".

+
`condor_status -vm` lists all of the available resources that HTCondor can
use to run jobs that require a virtual machine. All SWAMP jobs require
a virtual machine. On a normally functioning system, there should be at
least one "machine" in this list.

If any of these commands displays an error message, or if there are no
resources available for running _any_ jobs (i.e., `condor_status` lists
nothing), it is likely that the commands and HTCondor's daemons are failing
to communicate with each other successfully:

* On SWAMP-in-a-Box hosts with network interfaces that support both IPV4 and
  IPV6, one potential workaround is to force HTCondor to use IPV4. To do so,
  add `IPV6_ENABLE = false` to
  `/etc/condor/config.d/swampinabox_10_network.conf`.

If there are resources available for running jobs in general, but none for
jobs that require a virtual machine, continue to the next section.


==== Determining Whether HTCondor Supports KVM Virtualization ====

For SWAMP-in-a-Box, HTCondor is configured to use KVM virtualization for
running jobs that require a virtual machine. Run the following script to
determine whether the SWAMP-in-a-Box host supports KVM virtualization, as
described in the <<hardware-requirements,hardware requirements>> for
SWAMP-in-a-Box:

----
/opt/swamp/bin/swamp_check_virtualization_support
----

If run as `root` (or using `sudo`), the script will display additional
diagnostic output, which can be helpful in determining whether the
SWAMP-in-a-Box host is running directly on physical hardware versus inside
a virtual machine.

If the script does *not* find the necessary support for KVM virtualization,
it will display an error message and a suggestion on how to resolve the
issue.

If the script *does* find the necessary support for KVM virtualization, then
what likely happened is that some job failed to start its virtual machine
successfully. The immediate cause of the failure might be listed in
`/var/log/condor/VMGahpLog` (look around the times an assessment was
submitted or failed).

If the cause of the failure was transient, restarting the HTCondor service
will cause HTCondor to start running jobs that require a virtual machine
again. To restart the service, as `root` (or using `sudo`), run the
following command:

----
service condor restart
----

Note that it might take a minute or two after running this command for all
of HTCondor's daemons to restart and connect to each other.

If HTCondor again ends up not being able to run jobs that require a virtual
machine (i.e., `condor_status -vm` shows no available resources), then there
is likely a systemic issue. <<troubleshooting-collect-logs,Collect together
log files>> and <<support-and-contact-info,send them to SWAMP staff>> for
further investigation.
